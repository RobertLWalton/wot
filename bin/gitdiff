#!/bin/sh
#
# File:		gitdiff
# Author:	Bob Walton <walton@acm.org>
# Date:		Wed Jun 17 14:44:24 EDT 2015
#
# The author(s) have placed this program in the public
# domain; they make no warranty and accept no liability
# for this program.

fetch=no

case "$1" in -doc*)
    echo "
gitdiff [ l | r | {m} | ~m ] [ l | r | {n} | ~n ] \\
        [-n | -R | git-diff-option ...] \\
        [-a | [--] filename ...]
    Lists differences between the working versions of
    files and either a previous committed version of the
    files or the last gitadd'ed versions.

    \`l' is synonymous with \`~0', and \`r' is \
synonymous
    with \`origin/HEAD'.

    With no filenames or -a, lists differences for all
    files in the current directory and its subdirector-
    ies.  With -a, for all files in all repository
    directories.  Otherwise only for the listed files.

    With no commit name arguments, diffs working ver-
    sions the last gitadd'ed version if that exists,
    or the last committed version otherwise.  With one
    commit name, diffs the working version with the
    version in the commit.  With two commit names, diffs
    the versions in the two commits.

    The -n option is shorthand for the git diff option
    --name-status that just lists the names and status
    of the files with differences.  The -R option is a
    standard git diff option the reverses order of the
    files being diff'ed and may be useful in \`gitdiff
    r -R' when the remote is more up to date than the
    local version." | less -F

    exit 1
    ;;

l)
    src="~0"
    commit="HEAD~0"
    shift
    ;;

r)
    src="remote"
    commit="origin/HEAD"
    fetch=yes
    shift
    ;;

{*})
    src="$1"
    commit="HEAD@$1"
    shift
    ;;

~*)
    src="$1"
    commit="HEAD$1"
    shift
    ;;

*)
    src=index
    commit=""
    ;;
esac

case "$1" in

l)
    dst="~0"
    commit="$commit HEAD~0"
    shift
    ;;

r)
    dst="remote"
    commit="$commit origin/HEAD"
    fetch=yes
    shift
    ;;

{*})
    dst="$1"
    commit="$commit HEAD@$1"
    shift
    ;;

~*)
    dst="$1"
    commit="$commit HEAD$1"
    shift
    ;;

*)
    dst=working
    ;;
esac

options=""
while [ $# -ne 0 ]
do
    case "$1" in

    --)
        break
	;;

    -n)
	options="$options --name-status"
	shift
	;;

    -*)
	options="$options $1"
	shift
	;;

    *)
        break
	;;
    esac
done

if [ $fetch = "yes" ]
then
    git fetch
fi

case "$1" in

"")
    git diff --src-prefix="$src"/ \
             --dst-prefix="$dst"/ \
             $commit $options .
    ;;
"-a")
    git diff --src-prefix="$src"/ \
             --dst-prefix="$dst"/ \
             $commit $options
    ;;
*)
    git diff --src-prefix="$src"/ \
             --dst-prefix="$dst"/ \
             $commit $options "$@"
    ;;
esac
